name: codex-autopilot

on:
  issues:
    types: [labeled]

permissions:
  contents: write
  pull-requests: write
  issues: write
  statuses: write

jobs:
  codex:
    if: ${{ github.event.label.name == 'codex' }}
    runs-on: ubuntu-latest
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
      ISSUE_TITLE: ${{ github.event.issue.title }}
      ISSUE_BODY: ${{ github.event.issue.body }}
      BRANCH_NAME: codex/${{ github.event.issue.number }}
    steps:
      - name: React with eyes emoji
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue_number = context.issue.number;
            await github.rest.reactions.createForIssue({
              owner,
              repo,
              issue_number,
              content: 'eyes'
            });
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Set up Node 22 and Codex
        uses: actions/setup-node@v4
        with:
          node-version: 22
      - name: Install Codex
        run: |
          npm install -g @openai/codex
          export OPENAI_API_KEY="${{ secrets.OPENAI_API_KEY }}"
      - name: Run Codex in non-interactive CI mode
        run: |
          PROMPT="${ISSUE_TITLE}\n\n${ISSUE_BODY}"
          codex -a auto-edit -m o4-mini --w docs/ --quiet --flex-mode "$PROMPT"
      - name: Force origin to HTTPS with token
        run: |
          git config --local user.email "github-actions[codex-bot]@users.noreply.github.com"
          git config --local user.name "github-actions[codex-bot]"
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
      - name: Create pull request
        uses: peter-evans/create-pull-request@v6
        with:
          author: "github-actions[codex-bot] <github-actions[codex-bot]@users.noreply.github.com>"
          branch: ${{ env.BRANCH_NAME }}
          base: main
          commit-message: "Codex: ${{ env.ISSUE_TITLE }} (fixes #${{ github.event.issue.number }})"
          title: "Codex: ${{ env.ISSUE_TITLE }}"
          body: |
            Automated changes generated by Codex for **#${{ github.event.issue.number }}**.

            ---
            _This PR was created by the **codex-autopilot** workflow._
          delete-branch: true
          token: ${{ secrets.GITHUB_TOKEN }}
